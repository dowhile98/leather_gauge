/**
 *
 */

//-------------------------------------------------------------------------------
// includes
//-------------------------------------------------------------------------------
#include "lgc.h"
#include "lgc_interface_printer.h"
#include "error.h"
#include "os_port.h"
#include "ESC_POS_Printer.h"

//-------------------------------------------------------------------------------
// defines
//-------------------------------------------------------------------------------
#ifndef LGC_PRINTER_TASK_STACK
#define LGC_PRINTER_TASK_STACK 128
#endif

#ifndef LGC_PRINTER_TASK_PRI
#define LGC_PRINTER_TASK_PRI 10
#endif
//-------------------------------------------------------------------------------
// global variables
//-------------------------------------------------------------------------------
static esc_pos_printer_t lgc_printer = {0};

static OsTaskId lgc_printer_task = NULL;
//-------------------------------------------------------------------------------
// private function prototype
//-------------------------------------------------------------------------------
static void printer_delay(uint32_t ms);

static void lgc_printer_task_entry(void *params);
//-------------------------------------------------------------------------------
// public function definitions
//-------------------------------------------------------------------------------
uint8_t lgc_printer_connected(void)
{
	return lgc_interface_printer_connected();
}
//-------------------------------------------------------------------------------
// private function definition
//-------------------------------------------------------------------------------
static void printer_delay(uint32_t ms)
{
	osDelayTask(ms);
}
//-------------------------------------------------------------------------------
// public
//-------------------------------------------------------------------------------
error_t lgc_printer_init(void)
{
	OsTaskParameters params = OS_TASK_DEFAULT_PARAMS;
	error_t err = NO_ERROR;

	esc_pos_init(&lgc_printer, lgc_interface_printer_writeData, printer_delay, PRINTER_80MM);



	params.priority = LGC_PRINTER_TASK_PRI;
	params.stackSize = LGC_PRINTER_TASK_STACK;

	lgc_printer_task = osCreateTask("printer", lgc_printer_task_entry, NULL, &params);

	if(!lgc_printer_task)
	{
		err = ERROR_FAILURE;
	}

	return err;
}


static void lgc_printer_task_entrye(void *params)
{
	/*wait for printer connected*/
	do
	{
		//delay
		osDelayTask(100);
		//verify
	}while(lgc_interface_printer_connected() == 0);
	//printer is ready
	osDelayTask(50);

	esc_pos_set_align(&printer, ALIGN_CENTER);
	esc_pos_print_text(&printer, (char *)"\rHOL MUNDO\r\n");
	esc_pos_set_align(&printer, ALIGN_LEFT);

	for(;;)
	{
		osDelayTask(1000);
	}
}
