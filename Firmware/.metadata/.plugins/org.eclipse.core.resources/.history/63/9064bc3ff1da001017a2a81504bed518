
/* ============================================================================
 * Includes
 * ========================================================================= */
#include "lg_module_sensor.h"
#include "adc.h"
#include "tim.h"
/* ============================================================================
 * global variables
 * ========================================================================= */
#ifndef LG_ADC_FS
#define LG_ADC_FS 100.0f
#endif
/* ============================================================================
 * global variables
 * ========================================================================= */
static LG_SENSOR_TypeDef_t sensor = {0};
static Biquad_t filter[LG_ADC_SENAOR_MAX_SIZE] = {0};
/* ============================================================================
 * private function prototype
 * ========================================================================= */

/* ============================================================================
 * public function definition
 * ========================================================================= */
uint8_t lg_module_sensor_init(float fc)
{
    uint8_t ret = 0;
    /*filte init*/
    for (uint8_t i = 0; i < LG_ADC_SENAOR_MAX_SIZE; i++)
    {
        Biquad_Init(&filter[i], BQ_LOWPASS, fc, LG_ADC_FS, 0.707f);
    }
    /*adc init*/
    if (HAL_ADCEx_Calibration_Start(&hadc1) != HAL_OK)
    {
        return 1;
    }

    if (HAL_ADC_Start_DMA(&hadc1, (uint32_t *)sensor.raw, LG_ADC_SENAOR_MAX_SIZE) != HAL_OK)
    {
        return 1;
    }

    /*start timer triger*/
    if (HAL_TIM_Base_Start(&htim3) != HAL_OK)
    {
        return 1;
    }

    return ret;
}

uint8_t lg_module_sensor_get(LG_SENSOR_TypeDef_t *out)
{
    memcpy(out, &sensor, sizeof(LG_SENSOR_TypeDef_t));

    return 0;
}
/* ============================================================================
 * private function definition
 * ========================================================================= */

void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef *hadc)
{
    float adc;
    /* Prevent unused argument(s) compilation warning */

    /*filter data*/
    for (uint8_t i = 0; i < LG_ADC_SENAOR_MAX_SIZE; i++)
    {
        /*apply filter*/
        sensor.S[i] = Biquad_Apply(&filter[i], sensor.raw[i]);
    }
    return;
}
